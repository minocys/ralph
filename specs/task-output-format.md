# Task Output Format

Replace JSONL output with markdown-KV format for `plan-export` and `peek` to reduce token overhead when passing task state to LLMs.

## Requirements

### Markdown-KV Format

- Each task is a `## Task {id}` section followed by `key: value` lines
- Keys use full names (not short keys): `id`, `title`, `priority`, `status`, `category`, `spec`, `ref`, `assignee`, `deps`
- `deps` is a comma-separated list of task IDs (e.g., `deps: task-cli/01, task-store/02`)
- `steps` is rendered as a markdown bullet list under a `steps:` key, one `- ` item per step
- Null or empty fields must be omitted entirely (no `category:` line if category is null)
- Tasks are separated by a blank line between sections
- Example output for a single task:

```
## Task task-cli/01
id: task-cli/01
title: Implement CLI skeleton
priority: 0
status: active
category: feat
spec: task-cli.md
assignee: a7f2
deps: task-store/01
steps:
- Set up argument parsing
- Add help text
- Connect to database
```

### plan-export

- `task plan-export` must default to the human-readable table format (same columns as `task list`: ID, P, S, CAT, TITLE, AGENT)
- `task plan-export --markdown` must output markdown-KV format for machine consumption
- The command must still dump the full task DAG (all statuses including deleted)
- Sort order is unchanged: priority ASC, then created_at ASC

### peek

- `task peek [-n N]` must output markdown-KV format instead of JSONL
- Claimable tasks show `status: open`, active tasks show `status: active` with an `assignee` field
- Sort order and query logic are unchanged

### claim

- `task claim` must output markdown-KV format instead of JSON
- Include `lease_expires_at`, `retry_count`, and `blocker_results` fields
- `blocker_results` is rendered as a nested list under `blocker_results:` with `- {id}: {result_json}` per blocker

### Loop Integration

- `lib/loop.sh` must call `task plan-export --markdown` in plan mode
- `lib/loop.sh` must pass the markdown-KV output to the skill prompt unchanged
- No other changes to loop.sh logic (exit conditions, error handling remain the same)

### Skill Prompts

- `ralph-build` SKILL.md step 0b must describe the input as markdown-KV instead of JSONL
- `ralph-plan` SKILL.md step 0b must describe the input as markdown-KV instead of JSONL
- The planner still writes JSONL to `task plan-sync` stdin — only the read path changes

### list

- `task list --markdown` must output markdown-KV format (replaces the old `--json` flag)
- The default table format for `task list` is unchanged (human inspection)

## Constraints

- `task plan-sync` input format remains JSONL — it is machine-generated by the planner and does not need to be token-efficient
- The table format for `task list` (default, no flags) is unchanged
- `task show` output is unchanged (it is a human-facing detail view, not piped to LLMs)
- Markdown-KV output must go to stdout; errors to stderr
- Exit codes are unchanged for all commands

## Out of Scope

- Changing `task plan-sync` input format
- Changing `task show` output format
- Parsing markdown-KV in loop.sh (it is passed through to Claude as-is)
- Changing `task done`, `task fail`, or `task create` output (these are short confirmation messages)
