# Task Output Format

Replace JSONL output with markdown-KV format for `list --all` and `peek` to reduce token overhead when passing task state to LLMs.

## Requirements

### Markdown-KV Format

- Each task is a `## Task {id}` section followed by `key: value` lines
- Keys use full names (not short keys): `id`, `title`, `priority`, `status`, `category`, `spec`, `ref`, `assignee`, `deps`
- `deps` is a comma-separated list of task IDs (e.g., `deps: task-cli/01, task-store/02`)
- `steps` is rendered as a markdown bullet list under a `steps:` key, one `- ` item per step
- Null or empty fields must be omitted entirely (no `category:` line if category is null)
- Tasks are separated by a blank line between sections
- Example output for a single task:

```
## Task task-cli/01
id: task-cli/01
title: Implement CLI skeleton
priority: 0
status: active
category: feat
spec: task-cli.md
assignee: a7f2
deps: task-store/01
steps:
- Set up argument parsing
- Add help text
- Connect to database
```

### list --all

- `ralph task list --all` must show all tasks including deleted (full DAG), using the human-readable table format by default (same columns as `ralph task list`: ID, P, S, CAT, TITLE, AGENT)
- `ralph task list --all --markdown` must output markdown-KV format for machine consumption
- Sort order is unchanged: priority ASC, then created_at ASC
- `plan-export` has been removed — `ralph task list --all` is the replacement (see `specs/deprecate-plan-export.md`)

### peek

- `ralph task peek [-n N]` must output markdown-KV format instead of JSONL
- Claimable tasks show `status: open`, active tasks show `status: active` with an `assignee` field
- Sort order and query logic are unchanged

### claim

- `ralph task claim` must output markdown-KV format instead of JSON
- Include `lease_expires_at`, `retry_count`, and `blocker_results` fields
- `blocker_results` is rendered as a nested list under `blocker_results:` with `- {id}: {result_json}` per blocker

### Loop Integration

- `lib/plan_loop.sh` must call `ralph task list --all --markdown` before each plan-mode Claude invocation
- `lib/build_loop.sh` must call `ralph task peek -n 10` before each build-mode Claude invocation
- Both loops pass the markdown-KV output to the skill prompt unchanged

### Skill Prompts

- `ralph-build` SKILL.md step 0b must describe the input as markdown-KV instead of JSONL
- `ralph-plan` SKILL.md step 0b must describe the input as markdown-KV instead of JSONL
- The planner still writes JSONL to `ralph task plan-sync` stdin — only the read path changes

### list

- `ralph task list --markdown` must output markdown-KV format (replaces the old `--json` flag)
- The default table format for `ralph task list` is unchanged (human inspection)

## Constraints

- `ralph task plan-sync` input format remains JSONL — it is machine-generated by the planner and does not need to be token-efficient
- The table format for `ralph task list` (default, no flags) is unchanged; `ralph task list --all` uses the same table format
- `ralph task show` output is unchanged (it is a human-facing detail view, not piped to LLMs)
- Markdown-KV output must go to stdout; errors to stderr
- Exit codes are unchanged for all commands

## Out of Scope

- Changing `ralph task plan-sync` input format
- Changing `ralph task show` output format
- Parsing markdown-KV in loop.sh (it is passed through to Claude as-is)
- Changing `ralph task done`, `ralph task fail`, or `ralph task create` output (these are short confirmation messages)
