[
  {
    "category": "feat",
    "description": "Implement `task create` command",
    "steps": [
      "Parse flags: -p PRIORITY, -c CATEGORY, -d DESCRIPTION, -s STEPS_JSON, -r SPEC_REF, --ref REF, --deps DEP_IDS",
      "Accept positional <title> as first arg after `create`, and planner-assigned <id> as required argument",
      "INSERT into tasks table, INSERT steps from STEPS_JSON into task_steps, INSERT deps into task_deps",
      "Set updated_at to now() on insert",
      "Print the task ID to stdout on success",
      "Write bats tests: create with all flags, create with minimal args, missing title errors"
    ],
    "completed": true,
    "notes": "Implemented with full flag parsing (-p, -c, -d, -s, -r, --ref, --deps), SQL escaping via sed for single quotes, transactional inserts (BEGIN/COMMIT with ON_ERROR_STOP), steps from JSON array, comma-separated deps. Test file: test/task_create.bats with 11 tests. DB connection uses postgres://ralph:ralph@localhost:5432/ralph (not ralph:pass as documented in docker-compose)."
  },
  {
    "category": "feat",
    "description": "Implement `task list` command",
    "steps": [
      "Parse flags: --status (comma-separated filter, default all non-deleted), --json",
      "Query tasks excluding status='deleted', filter by --status if provided",
      "Default output: aligned table format (ID, P, S, CAT, TITLE, AGENT)",
      "With --json: output JSONL with short keys (id, t, d, p, s, cat, spec, ref, deps, steps)",
      "Write bats tests: list default, list --status open, list --json format"
    ],
    "completed": true,
    "notes": "Implemented with --status (comma-separated filter, default excludes deleted) and --json flags. Table format shows ID, P, S, CAT, TITLE, AGENT columns aligned. JSONL uses short keys (id, t, d, p, s, cat, spec, ref, deps, steps) with subquery joins for deps/steps. Fixed ensure_schema to suppress NOTICE messages with SET client_min_messages TO WARNING. Test file: test/task_list.bats with 13 tests."
  },
  {
    "category": "feat",
    "description": "Implement `task show` command",
    "steps": [
      "Accept <id> positional arg, parse --with-deps flag",
      "Query task by ID, join task_steps, join task_deps",
      "Print full detail for the task",
      "With --with-deps: also query and print result JSONB from blocker tasks",
      "Exit code 2 if task not found",
      "Write bats tests: show existing task, show with deps, show nonexistent exits 2"
    ],
    "completed": true,
    "notes": "Implemented cmd_show with full detail output: ID, Title, Status, Priority, Category, Description, Spec, Ref, Assignee, Lease, Retries, Result, Created, Updated, Deleted (null fields omitted). Steps displayed as numbered list with status. Dependencies shown with blocker status. --with-deps flag adds Blocker Results section showing result JSONB from completed blockers. Exit code 2 for not found. SQL escaping for task ID. Test file: test/task_show.bats with 10 tests."
  },
  {
    "category": "feat",
    "description": "Implement `task update` command",
    "steps": [
      "Accept <id> positional arg, parse --title, --priority, --description, --steps, --status flags",
      "Verify task is not done (done tasks are immutable), exit 1 if done",
      "UPDATE only provided fields, always set updated_at to now()",
      "If --steps provided, DELETE existing steps and INSERT new ones",
      "Write bats tests: update title, update priority, reject update on done task"
    ],
    "completed": true,
    "notes": "Implemented cmd_update with flag parsing (--title, --priority, --description, --steps, --status). Checks task exists (exit 2 if not found) and is not done (exit 1 if done). Dynamic SET clause builds only provided fields. Steps replacement uses DELETE+INSERT in a transaction. SQL escaping via sed for single quotes. Prints 'updated <id>' on success. Test file: test/task_update.bats with 14 tests covering validation, field updates, steps replacement, multiple fields, special characters."
  },
  {
    "category": "feat",
    "description": "Implement `task delete` command (soft delete)",
    "steps": [
      "Accept <id> positional arg",
      "UPDATE status to 'deleted', set deleted_at and updated_at to now()",
      "Exit code 2 if task not found",
      "Write bats tests: delete existing task, delete nonexistent exits 2, deleted task excluded from list"
    ],
    "completed": false
  },
  {
    "category": "feat",
    "description": "Implement `task block` and `task unblock` dependency commands",
    "steps": [
      "task block <id> --by <blocker-id>: INSERT into task_deps(task_id, blocked_by)",
      "task unblock <id> --by <blocker-id>: DELETE from task_deps where task_id and blocked_by match",
      "Write bats tests: add dependency, remove dependency, verify deps appear in task show"
    ],
    "completed": false
  },
  {
    "category": "feat",
    "description": "Implement `task deps` command",
    "steps": [
      "Accept <id> positional arg",
      "Query task_deps recursively to build dependency tree",
      "Print tree showing blocker chain",
      "Write bats tests: deps with no blockers, deps with chain"
    ],
    "completed": false
  },
  {
    "category": "feat",
    "description": "Implement `task claim` command with atomic locking (task-scheduling spec)",
    "steps": [
      "Parse --lease flag (default 600 seconds)",
      "Single SQL transaction: SELECT highest-priority task WHERE (status='open' OR (status='active' AND lease_expires_at < now())) AND all blockers are done/deleted, FOR UPDATE SKIP LOCKED",
      "UPDATE: set status='active', assignee=agent_id, lease_expires_at=now()+lease, increment retry_count if reclaiming expired",
      "Return full task JSON including blocker_results (result JSONB from resolved blockers)",
      "Exit code 2 if no eligible task",
      "Write bats tests: claim returns task, claim with no tasks exits 2, claim skips blocked tasks"
    ],
    "completed": false
  },
  {
    "category": "feat",
    "description": "Implement `task renew` command",
    "steps": [
      "Accept <id> positional arg, parse --lease flag (default 600)",
      "Verify caller is current assignee within a transaction",
      "UPDATE lease_expires_at to now() + lease duration",
      "Write bats tests: renew extends lease, renew fails for non-assignee"
    ],
    "completed": false
  },
  {
    "category": "feat",
    "description": "Implement `task step-done` command",
    "steps": [
      "Accept <id> and <seq> positional args",
      "UPDATE task_steps SET status='done' WHERE task_id=id AND seq=seq",
      "Write bats test: mark step done, verify step status changes"
    ],
    "completed": false
  },
  {
    "category": "feat",
    "description": "Implement `task done` command",
    "steps": [
      "Accept <id> positional arg, parse --result flag (JSON string)",
      "Verify task status is 'active', exit 1 otherwise",
      "UPDATE: set status='done', store result JSONB, set updated_at",
      "Write bats tests: done on active task, done on non-active exits 1, result JSON stored correctly"
    ],
    "completed": false
  },
  {
    "category": "feat",
    "description": "Implement `task fail` command",
    "steps": [
      "Accept <id> positional arg, parse --reason flag",
      "UPDATE: set status='open', clear assignee, clear lease_expires_at, increment retry_count, set updated_at",
      "Write bats tests: fail releases task, retry_count increments, task is re-claimable"
    ],
    "completed": false
  },
  {
    "category": "feat",
    "description": "Implement `task plan-sync` command (idempotent plan synchronization)",
    "steps": [
      "Read JSONL from stdin, group tasks by spec_ref",
      "Single transaction: for each task in stdin — skip if done, upsert if exists, insert if new",
      "For tasks in DB with matching spec_ref not in stdin — soft delete unless done",
      "Print summary: inserted: N, updated: N, deleted: N, skipped (done): N",
      "Write bats tests: sync inserts new tasks, sync updates existing, sync deletes removed, sync skips done, sync is idempotent (second run = no changes)"
    ],
    "completed": false
  },
  {
    "category": "feat",
    "description": "Implement `task plan-export` command",
    "steps": [
      "Parse --json flag",
      "Default: print aligned table of full task DAG",
      "With --json: output JSONL with short keys",
      "Write bats tests: export table format, export JSON format"
    ],
    "completed": false
  },
  {
    "category": "feat",
    "description": "Implement `task plan-status` command",
    "steps": [
      "Query count by status (open, active, done, blocked, deleted)",
      "Blocked = tasks with unresolved blockers (not all done/deleted)",
      "Print summary line: N open, N active, N done, N blocked, N deleted",
      "Write bats test: status output matches expected counts"
    ],
    "completed": false
  },
  {
    "category": "feat",
    "description": "Implement `task agent register` command (agent-lifecycle spec)",
    "steps": [
      "Generate random 4-char hex ID, check for collision, retry if needed",
      "INSERT into agents: id, PID ($$), hostname ($HOSTNAME or $(hostname)), started_at=now(), status='active'",
      "Print agent ID to stdout",
      "Write bats tests: register returns 4-char hex, register creates active agent"
    ],
    "completed": false
  },
  {
    "category": "feat",
    "description": "Implement `task agent list` command",
    "steps": [
      "Query agents table, print ID, PID, hostname, started_at, status",
      "Write bats test: list shows registered agent"
    ],
    "completed": false
  },
  {
    "category": "feat",
    "description": "Implement `task agent deregister` command",
    "steps": [
      "Accept <id> positional arg",
      "UPDATE agents SET status='stopped' WHERE id=<id>",
      "Write bats tests: deregister changes status to stopped"
    ],
    "completed": false
  },
  {
    "category": "feat",
    "description": "Integrate agent lifecycle into ralph.sh build loop",
    "steps": [
      "Before entering the build loop, call `task agent register` and capture agent ID",
      "Pass agent ID to claude via environment variable or prompt context",
      "Add trap handler: on EXIT/INT/TERM, call `task agent deregister <id>`",
      "Write bats test: ralph.sh in build mode registers and deregisters agent (requires task script stub)"
    ],
    "completed": false
  },
  {
    "category": "feat",
    "description": "Add `task` script to install.sh",
    "steps": [
      "Symlink `task` script into ~/.local/bin alongside ralph",
      "Write bats test: install.sh creates task symlink"
    ],
    "completed": false
  },
  {
    "category": "doc",
    "description": "Update README.md with task management documentation",
    "steps": [
      "Add Task Management section documenting `task` CLI commands",
      "Document Docker Compose setup for PostgreSQL",
      "Document RALPH_DB_URL environment variable",
      "Update project structure diagram to include task script and docker-compose.yml"
    ],
    "completed": false
  }
]
