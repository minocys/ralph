[
  {
    "category": "feat",
    "description": "Implement `task create` command",
    "steps": [
      "Parse flags: -p PRIORITY, -c CATEGORY, -d DESCRIPTION, -s STEPS_JSON, -r SPEC_REF, --ref REF, --deps DEP_IDS",
      "Accept positional <title> as first arg after `create`, and planner-assigned <id> as required argument",
      "INSERT into tasks table, INSERT steps from STEPS_JSON into task_steps, INSERT deps into task_deps",
      "Set updated_at to now() on insert",
      "Print the task ID to stdout on success",
      "Write bats tests: create with all flags, create with minimal args, missing title errors"
    ],
    "completed": true,
    "notes": "Implemented with full flag parsing (-p, -c, -d, -s, -r, --ref, --deps), SQL escaping via sed for single quotes, transactional inserts (BEGIN/COMMIT with ON_ERROR_STOP), steps from JSON array, comma-separated deps. Test file: test/task_create.bats with 11 tests. DB connection uses postgres://ralph:ralph@localhost:5432/ralph (not ralph:pass as documented in docker-compose)."
  },
  {
    "category": "feat",
    "description": "Implement `task list` command",
    "steps": [
      "Parse flags: --status (comma-separated filter, default all non-deleted), --json",
      "Query tasks excluding status='deleted', filter by --status if provided",
      "Default output: aligned table format (ID, P, S, CAT, TITLE, AGENT)",
      "With --json: output JSONL with short keys (id, t, d, p, s, cat, spec, ref, deps, steps)",
      "Write bats tests: list default, list --status open, list --json format"
    ],
    "completed": true,
    "notes": "Implemented with --status (comma-separated filter, default excludes deleted) and --json flags. Table format shows ID, P, S, CAT, TITLE, AGENT columns aligned. JSONL uses short keys (id, t, d, p, s, cat, spec, ref, deps, steps) with subquery joins for deps/steps. Fixed ensure_schema to suppress NOTICE messages with SET client_min_messages TO WARNING. Test file: test/task_list.bats with 13 tests."
  },
  {
    "category": "feat",
    "description": "Implement `task show` command",
    "steps": [
      "Accept <id> positional arg, parse --with-deps flag",
      "Query task by ID, join task_steps, join task_deps",
      "Print full detail for the task",
      "With --with-deps: also query and print result JSONB from blocker tasks",
      "Exit code 2 if task not found",
      "Write bats tests: show existing task, show with deps, show nonexistent exits 2"
    ],
    "completed": true,
    "notes": "Implemented cmd_show with full detail output: ID, Title, Status, Priority, Category, Description, Spec, Ref, Assignee, Lease, Retries, Result, Created, Updated, Deleted (null fields omitted). Steps displayed as numbered list with status. Dependencies shown with blocker status. --with-deps flag adds Blocker Results section showing result JSONB from completed blockers. Exit code 2 for not found. SQL escaping for task ID. Test file: test/task_show.bats with 10 tests."
  },
  {
    "category": "feat",
    "description": "Implement `task update` command",
    "steps": [
      "Accept <id> positional arg, parse --title, --priority, --description, --steps, --status flags",
      "Verify task is not done (done tasks are immutable), exit 1 if done",
      "UPDATE only provided fields, always set updated_at to now()",
      "If --steps provided, DELETE existing steps and INSERT new ones",
      "Write bats tests: update title, update priority, reject update on done task"
    ],
    "completed": true,
    "notes": "Implemented cmd_update with flag parsing (--title, --priority, --description, --steps, --status). Checks task exists (exit 2 if not found) and is not done (exit 1 if done). Dynamic SET clause builds only provided fields. Steps replacement uses DELETE+INSERT in a transaction. SQL escaping via sed for single quotes. Prints 'updated <id>' on success. Test file: test/task_update.bats with 14 tests covering validation, field updates, steps replacement, multiple fields, special characters."
  },
  {
    "category": "feat",
    "description": "Implement `task delete` command (soft delete)",
    "steps": [
      "Accept <id> positional arg",
      "UPDATE status to 'deleted', set deleted_at and updated_at to now()",
      "Exit code 2 if task not found",
      "Write bats tests: delete existing task, delete nonexistent exits 2, deleted task excluded from list"
    ],
    "completed": true,
    "notes": "Implemented cmd_delete with soft delete: sets status='deleted', deleted_at=now(), updated_at=now(). Exit code 2 if task not found, exit 1 if missing ID. SQL escaping via sed for single quotes. Prints 'deleted <id>' on success. Test file: test/task_delete.bats with 10 tests covering argument validation, not found, status/timestamp changes, list exclusion, status filter, special characters, record preservation, and show visibility."
  },
  {
    "category": "feat",
    "description": "Implement `task block` and `task unblock` dependency commands",
    "steps": [
      "task block <id> --by <blocker-id>: INSERT into task_deps(task_id, blocked_by)",
      "task unblock <id> --by <blocker-id>: DELETE from task_deps where task_id and blocked_by match",
      "Write bats tests: add dependency, remove dependency, verify deps appear in task show"
    ],
    "completed": true,
    "notes": "Implemented cmd_block and cmd_unblock. block validates both task and blocker exist (exit 2 if not found), uses ON CONFLICT DO NOTHING for idempotency. unblock checks DELETE row count, exits 2 if dependency not found. SQL escaping via sed for single quotes. Test file: test/task_block.bats with 16 tests covering argument validation, not found cases, successful block/unblock, idempotency, integration with show and list --json, selective unblock, and special characters."
  },
  {
    "category": "feat",
    "description": "Implement `task deps` command",
    "steps": [
      "Accept <id> positional arg",
      "Query task_deps recursively to build dependency tree",
      "Print tree showing blocker chain",
      "Write bats tests: deps with no blockers, deps with chain"
    ],
    "completed": true,
    "notes": "Implemented cmd_deps with recursive CTE (WITH RECURSIVE dep_tree) to walk the full dependency graph. Accepts <id> positional arg, validates task exists (exit 2 if not found), exit 1 if missing ID. Prints '(no dependencies)' when no blockers. Tree output shows indented hierarchy with depth-based indentation (2 spaces per level), blocker ID, status in brackets, and title. Handles diamond dependencies, deep chains (3+ levels), and special characters. Test file: test/task_deps.bats with 11 tests covering argument validation, not found, no deps, direct blockers, status display, title display, transitive chains, indentation, deep chains, diamond patterns, and special characters."
  },
  {
    "category": "feat",
    "description": "Implement `task claim` command with atomic locking (task-scheduling spec)",
    "steps": [
      "Parse --lease flag (default 600 seconds)",
      "Single SQL transaction: SELECT highest-priority task WHERE (status='open' OR (status='active' AND lease_expires_at < now())) AND all blockers are done/deleted, FOR UPDATE SKIP LOCKED",
      "UPDATE: set status='active', assignee=agent_id, lease_expires_at=now()+lease, increment retry_count if reclaiming expired",
      "Return full task JSON including blocker_results (result JSONB from resolved blockers)",
      "Exit code 2 if no eligible task",
      "Write bats tests: claim returns task, claim with no tasks exits 2, claim skips blocked tasks"
    ],
    "completed": true,
    "notes": "Implemented cmd_claim with single atomic SQL transaction using CTE (WITH eligible AS ... WITH claimed AS ...). Uses SELECT FOR UPDATE SKIP LOCKED for concurrent safety. Eligible tasks: status='open' OR (status='active' AND lease_expires_at < now()), with all blockers done/deleted via NOT EXISTS subquery. Priority ordering: priority ASC, created_at ASC. Updates: status='active', assignee from --agent flag or RALPH_AGENT_ID env var, lease_expires_at=now()+interval, retry_count incremented only on reclaim of expired lease. Returns JSON with short keys (id, t, d, p, s, cat, spec, ref, assignee, lease_expires_at, retry_count, deps, steps, blocker_results). Exit 2 if no eligible task. Test file: test/task_claim.bats with 18 tests covering priority ordering, blocked task skipping, lease expiry/reclaim, retry_count increment, steps/deps in output, blocker_results, edge cases."
  },
  {
    "category": "feat",
    "description": "Implement `task renew` command",
    "steps": [
      "Accept <id> positional arg, parse --lease flag (default 600)",
      "Verify caller is current assignee within a transaction",
      "UPDATE lease_expires_at to now() + lease duration",
      "Write bats tests: renew extends lease, renew fails for non-assignee"
    ],
    "completed": true,
    "notes": "Implemented cmd_renew with positional <id> arg, --lease flag (default 600s), --agent flag (overrides RALPH_AGENT_ID env var). Validates task exists (exit 2 if not found), status is active (exit 1 if not), and caller is current assignee (exit 1 if mismatch). Extends lease_expires_at via UPDATE in transaction, sets updated_at=now(). Prints 'renewed <id>' on success. SQL escaping via sed for single quotes. Test file: test/task_renew.bats with 12 tests covering argument validation, not found, status checks, assignee verification, successful renew with default/custom lease, timestamp update, --agent flag override, claim+renew workflow, and special characters in task ID."
  },
  {
    "category": "feat",
    "description": "Implement `task step-done` command",
    "steps": [
      "Accept <id> and <seq> positional args",
      "UPDATE task_steps SET status='done' WHERE task_id=id AND seq=seq",
      "Write bats test: mark step done, verify step status changes"
    ],
    "completed": true,
    "notes": "Implemented cmd_step_done with positional <id> and <seq> args. Validates task exists (exit 2 if not found), validates step exists (exit 2 if not found). Updates step status to 'done' idempotently (marking already-done step succeeds). Prints 'step-done <id> <seq>' on success. SQL escaping via sed for single quotes. Test file: test/task_step_done.bats with 11 tests covering argument validation, not found cases (task and step), successful marking, selective step update, idempotency, integration with show output, special characters, single quotes, and sequential multi-step completion."
  },
  {
    "category": "feat",
    "description": "Implement `task done` command",
    "steps": [
      "Accept <id> positional arg, parse --result flag (JSON string)",
      "Verify task status is 'active', exit 1 otherwise",
      "UPDATE: set status='done', store result JSONB, set updated_at",
      "Write bats tests: done on active task, done on non-active exits 1, result JSON stored correctly"
    ],
    "completed": true,
    "notes": "Implemented cmd_done with positional <id> arg and --result flag (JSON string). Validates task exists (exit 2 if not found) and status is active (exit 1 if not). Updates status to 'done', sets updated_at=now(), optionally stores result as JSONB via '::jsonb' cast. SQL escaping via sed for single quotes. Prints 'done <id>' on success. Implicitly unblocks downstream tasks (verified in integration test with claim). Test file: test/task_done.bats with 14 tests covering argument validation, not found, status checks (open/already done), successful completion, updated_at, result JSONB storage, no-result case, downstream unblocking, show integration, special characters, single quotes, and special JSON characters."
  },
  {
    "category": "feat",
    "description": "Implement `task fail` command",
    "steps": [
      "Accept <id> positional arg, parse --reason flag",
      "UPDATE: set status='open', clear assignee, clear lease_expires_at, increment retry_count, set updated_at",
      "Write bats tests: fail releases task, retry_count increments, task is re-claimable"
    ],
    "completed": true,
    "notes": "Implemented cmd_fail with positional <id> arg and optional --reason flag. Validates task exists (exit 2 if not found) and status is active (exit 1 if not). Updates: status='open', assignee=NULL, lease_expires_at=NULL, retry_count incremented, updated_at=now(). The --reason flag is accepted but not persisted (no schema column for it). Prints 'failed <id>' on success. SQL escaping via sed for single quotes. Test file: test/task_fail.bats with 16 tests covering argument validation, not found, status checks (open/done), successful fail, state changes (status/assignee/lease/retry_count/updated_at), cumulative retry_count, --reason flag, re-claim integration, claim-fail cycle retry tracking, and special characters."
  },
  {
    "category": "feat",
    "description": "Implement `task plan-sync` command (idempotent plan synchronization)",
    "steps": [
      "Read JSONL from stdin, group tasks by spec_ref",
      "Single transaction: for each task in stdin — skip if done, upsert if exists, insert if new",
      "For tasks in DB with matching spec_ref not in stdin — soft delete unless done",
      "Print summary: inserted: N, updated: N, deleted: N, skipped (done): N",
      "Write bats tests: sync inserts new tasks, sync updates existing, sync deletes removed, sync skips done, sync is idempotent (second run = no changes)"
    ],
    "completed": true,
    "notes": "Implemented cmd_plan_sync with full diff algorithm per spec. Reads JSONL from stdin, processes per spec_ref group: skips done tasks (immutable), updates existing non-done tasks (title, description, category, priority, steps, deps), inserts new tasks as open. Soft-deletes tasks in DB whose spec_ref matches stdin but whose ID is not in stdin (preserves done tasks). Single SQL transaction via BEGIN/COMMIT with ON_ERROR_STOP. Prints summary: inserted: N, updated: N, deleted: N, skipped (done): N. Idempotent — second run with same input produces no new inserts. Uses jq for JSON parsing, sql_esc for SQL injection protection. Test file: test/task_plan_sync.bats with 13 tests covering empty input, inserts, steps/deps, updates, step/dep replacement, done task skipping, soft-delete of removed tasks, done task preservation, idempotency, multiple spec_refs, no-spec-ref isolation, special characters, and mixed operations."
  },
  {
    "category": "feat",
    "description": "Implement `task plan-export` command",
    "steps": [
      "Parse --json flag",
      "Default: print aligned table of full task DAG",
      "With --json: output JSONL with short keys",
      "Write bats tests: export table format, export JSON format"
    ],
    "completed": true,
    "notes": "Implemented cmd_plan_export with --json flag. Default: aligned table format (ID, P, S, CAT, TITLE, AGENT) showing all tasks including deleted (full DAG dump). --json: JSONL with short keys (id, t, d, p, s, cat, spec, ref, deps, steps) including subquery joins for deps/steps. Key difference from cmd_list: plan-export shows ALL statuses (no WHERE clause filtering), while list excludes deleted by default. Test file: test/task_plan_export.bats with 12 tests covering empty database, table format, deleted task inclusion, priority ordering, assignee display, JSON output, short keys, steps/deps, deleted in JSON, comparison with list behavior, and unknown flag rejection."
  },
  {
    "category": "feat",
    "description": "Implement `task plan-status` command",
    "steps": [
      "Query count by status (open, active, done, blocked, deleted)",
      "Blocked = tasks with unresolved blockers (not all done/deleted)",
      "Print summary line: N open, N active, N done, N blocked, N deleted",
      "Write bats test: status output matches expected counts"
    ],
    "completed": true,
    "notes": "Implemented cmd_plan_status with a single SQL query using a subquery to compute is_blocked per task (EXISTS check for unresolved blockers where blocker status NOT IN done/deleted). Blocked tasks are counted separately from their actual status (open/active). Output format: 'N open, N active, N done, N blocked, N deleted' on a single line. Rejects unknown flags with exit 1. Test file: test/task_plan_status.bats with 12 tests covering empty database, individual status counts, blocked task detection, resolved/deleted blocker handling, mixed statuses, single-line output format, active+blocked counting, and unknown flag rejection."
  },
  {
    "category": "feat",
    "description": "Implement `task agent register` command (agent-lifecycle spec)",
    "steps": [
      "Generate random 4-char hex ID, check for collision, retry if needed",
      "INSERT into agents: id, PID ($$), hostname ($HOSTNAME or $(hostname)), started_at=now(), status='active'",
      "Print agent ID to stdout",
      "Write bats tests: register returns 4-char hex, register creates active agent"
    ],
    "completed": true,
    "notes": "Implemented cmd_agent_register with random 4-char hex ID generation via /dev/urandom + od. Collision-safe with INSERT ON CONFLICT DO NOTHING + RETURNING id pattern, retries up to 10 times. Records shell PID ($$) and hostname ($HOSTNAME or $(hostname)). Sets started_at=now() and status='active' via schema defaults. Prints agent ID to stdout. sql_esc for SQL injection protection. Test file: test/task_agent_register.bats with 11 tests covering ID format validation, DB record creation (PID, hostname, status, started_at), uniqueness across multiple registrations, multiple agent records, and subcommand routing (missing/unknown)."
  },
  {
    "category": "feat",
    "description": "Implement `task agent list` command",
    "steps": [
      "Query agents table, print ID, PID, hostname, started_at, status",
      "Write bats test: list shows registered agent"
    ],
    "completed": true,
    "notes": "Implemented cmd_agent_list with ensure_schema call, SQL query ordering by started_at DESC. Output: aligned table format (ID, PID, HOSTNAME, STARTED, STATUS) with header row. Shows all agents (active and stopped). Returns 0 with no output when no agents exist. Test file: test/task_agent_list.bats with 10 tests covering empty database, single agent display, header row, status/PID/hostname/timestamp display, multiple agents, stopped agent visibility, column alignment."
  },
  {
    "category": "feat",
    "description": "Implement `task agent deregister` command",
    "steps": [
      "Accept <id> positional arg",
      "UPDATE agents SET status='stopped' WHERE id=<id>",
      "Write bats tests: deregister changes status to stopped"
    ],
    "completed": true,
    "notes": "Implemented cmd_agent_deregister with positional <id> arg. Validates agent exists via SELECT before UPDATE (exit 2 if not found), exit 1 if missing ID with usage hint. Sets status='stopped' idempotently (deregistering already-stopped agent succeeds). SQL escaping via local sql_esc function (pattern used by all cmd_* functions). Prints 'deregistered <id>' on success. Key learning: psql -tAX still outputs 'UPDATE 0' text for UPDATE...RETURNING with no matching rows, so must use SELECT-then-UPDATE pattern instead. Test file: test/task_agent_deregister.bats with 10 tests covering argument validation, not found, status change, idempotency, selective deregistration, agent list visibility, and full register+deregister workflow."
  },
  {
    "category": "feat",
    "description": "Integrate agent lifecycle into ralph.sh build loop",
    "steps": [
      "Before entering the build loop, call `task agent register` and capture agent ID",
      "Pass agent ID to claude via environment variable or prompt context",
      "Add trap handler: on EXIT/INT/TERM, call `task agent deregister <id>`",
      "Write bats test: ralph.sh in build mode registers and deregisters agent (requires task script stub)"
    ],
    "completed": true,
    "notes": "Implemented in ralph.sh: In build mode, registers agent via $SCRIPT_DIR/task agent register before loop entry, exports RALPH_AGENT_ID env var for Claude to use when claiming tasks. Cleanup function deregisters agent on EXIT (covers both normal exit and INT/TERM signals). Agent ID displayed in startup banner. Gracefully handles missing/non-executable task script (registration silently skipped). Plan mode skips registration entirely. Test file: test/ralph_agent_lifecycle.bats with 6 tests covering registration, deregistration on exit, RALPH_AGENT_ID export, plan mode exclusion, missing task script handling, and DB state verification."
  },
  {
    "category": "feat",
    "description": "Add `task` script to install.sh",
    "steps": [
      "Symlink `task` script into ~/.local/bin alongside ralph",
      "Write bats test: install.sh creates task symlink"
    ],
    "completed": false
  },
  {
    "category": "doc",
    "description": "Update README.md with task management documentation",
    "steps": [
      "Add Task Management section documenting `task` CLI commands",
      "Document Docker Compose setup for PostgreSQL",
      "Document RALPH_DB_URL environment variable",
      "Update project structure diagram to include task script and docker-compose.yml"
    ],
    "completed": false
  }
]
